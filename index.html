<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gonyang & Ddongkkae Diary</title>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        @font-face { font-family: 'DungGeunMo'; src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_six@1.2/DungGeunMo.woff') format('woff'); }
        :root { --diary-pink: #F4C2C2; --diary-dark-pink: #E89999; --belt-pink: #F4B2B2; --silver-frame: linear-gradient(145deg, #cfd8dc, #eceff1, #90a4ae); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; font-family: 'DungGeunMo', sans-serif; 
            background-color: #F8E0E0;
            background-image: radial-gradient(white 15%, transparent 16%), radial-gradient(white 15%, transparent 16%);
            background-size: 60px 60px;
            display: flex; flex-direction: column; align-items: center; 
            justify-content: center; height: 100vh; overflow: hidden;
            padding-bottom: 20px;
        }

        .wrapper { 
            position: relative; width: 90%; max-width: 340px; 
            height: 68vh; perspective: 1000px; margin-bottom: 20px;
        }

        .diary-container {
            width: 100%; height: 100%; position: absolute;
            background: var(--diary-pink); border-radius: 0 35px 35px 0; 
            box-shadow: 10px 20px 40px rgba(0,0,0,0.15);
            display: flex; flex-direction: column; z-index: 100;
            transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s;
            transform-origin: left; padding-top: 50px;
        }
        
        #cover-title {
            font-family: 'Jua', sans-serif; color: white; text-align: center; font-size: 31px; line-height: 1.4;
            letter-spacing: 0.12em;
            text-shadow: -2px -2px 0 var(--diary-dark-pink), 2px -2px 0 var(--diary-dark-pink), -2px 2px 0 var(--diary-dark-pink), 2px 2px 0 var(--diary-dark-pink), 0px 3px 6px rgba(0,0,0,0.1);
            margin: 0; z-index: 102; pointer-events: none;
        }

        .paper-area { 
            position: absolute; width: 94%; height: 96%; top: 2%; left: 0;
            background: white; border-radius: 0 25px 25px 0; z-index: 10;
            display: none; padding: 18px; flex-direction: column;
            border-left: 2px solid rgba(0,0,0,0.1);
        }
        .theme-grid { background-image: linear-gradient(#00000010 1px, transparent 1px), linear-gradient(90deg, #00000010 1px, transparent 1px); background-size: 20px 20px; }

        .diary-belt { 
            width: 150px; height: 75px; background: var(--belt-pink); 
            position: absolute; right: -5px; top: 50%; transform: translateY(-50%);
            border-radius: 15px 0 0 15px; z-index: 1000; 
            display: flex; align-items: center; justify-content: flex-start; padding-left: 15px; transition: 0.8s;
        }

        .silver-lock-frame { background: var(--silver-frame); padding: 5px; border-radius: 10px; display: flex; gap: 4px; }

        .sticker-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
        .sticker-wrapper {
            position: absolute; cursor: move; user-select: none; 
            touch-action: none; z-index: 110; padding: 12px;
            border: 2px dashed transparent; transform-origin: center center;
            display: flex; align-items: center; justify-content: center;
            pointer-events: auto;
        }
        .sticker-wrapper.selected { border: 2px dashed #666 !important; background: rgba(255,255,255,0.3); z-index: 500; }
        
        .delete-btn { 
            position: absolute; top: -12px; right: -12px; width: 28px; height: 28px; 
            background: #ff5252; color: white; border-radius: 50%; 
            display: none; align-items: center; justify-content: center; 
            font-size: 18px; border: 2px solid white; z-index: 600;
        }
        .resize-handle {
            position: absolute; bottom: -12px; right: -12px; width: 22px; height: 22px;
            background: white; border: 2px solid #666; border-radius: 50%;
            display: none; z-index: 600;
        }
        .sticker-wrapper.selected .delete-btn, 
        .sticker-wrapper.selected .resize-handle { display: flex !important; }

        .sticker-wrapper img { width: 100%; height: 100%; border: none; pointer-events: none; }
        .sticker-content { pointer-events: none; white-space: nowrap; font-size: 40px; }

        .global-controls { position: relative; display: flex; gap: 12px; z-index: 3000; }
        .control-btn { 
            background: white; border: 2px solid var(--diary-dark-pink); 
            padding: 10px 18px; border-radius: 12px; 
            font-size: 15px; font-family: 'DungGeunMo'; cursor: pointer; 
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 0 var(--diary-dark-pink); color: #444;
        }
        .control-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 var(--diary-dark-pink); }

        .side-tabs { position: absolute; right: -40px; top: 50px; display: none; flex-direction: column; gap: 8px; z-index: 500; }
        .tab { width: 40px; height: 60px; border-radius: 0 10px 10px 0; display: flex; align-items: center; justify-content: center; writing-mode: vertical-rl; cursor: pointer; color: white; font-size: 11px; }

        section { display: none; width: 100%; height: 100%; flex-direction: column; overflow: hidden; position: relative; z-index: 10; }
        section.active { display: flex; }

        .weather-btn, .author-btn { font-size: 20px; cursor: pointer; opacity: 0.3; transition: 0.2s; display: inline-block; padding: 4px; }
        .weather-btn.selected, .author-btn.selected { opacity: 1; transform: scale(1.2); filter: drop-shadow(0 0 2px pink); }

        .title-row { display: flex; align-items: center; border-bottom: 2px solid #00000010; margin-bottom: 8px; padding: 2px 0; }
        .title-label { font-size: 14px; color: #333; margin-right: 5px; white-space: nowrap; }
        .title-input { flex: 1; font-size: 15px; border:none; outline:none; font-family: 'DungGeunMo'; background: transparent; }
        
        .dial-window { width: 28px; height: 38px; background: white; border-radius: 4px; overflow: hidden; position: relative; border: 1.5px solid #78909c; }
        .dial-strip { position: absolute; top: 0; left: 0; width: 100%; transition: transform 0.4s; display: flex; flex-direction: column; }
        .dial-number { width: 28px; height: 38px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #333; font-weight: bold; }

        #custom-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 5000; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 20px; border-radius: 20px; width: 80%; max-width: 300px;
            text-align: center; border: 3px solid var(--diary-pink);
        }
        .modal-content input {
            width: 100%; padding: 10px; margin: 15px 0; border: 2px solid #eee;
            border-radius: 10px; font-family: 'DungGeunMo'; outline: none; text-align: center;
        }
        .modal-btns { display: flex; gap: 10px; justify-content: center; }
        .modal-btns button {
            padding: 8px 15px; border-radius: 10px; border: none; font-family: 'DungGeunMo'; cursor: pointer;
        }
    </style>
</head>
<body onclick="deselectAll(event)">

    <div class="wrapper">
        <div class="diary-container" id="diary-cover">
            <h2 id="cover-title">Í≥†ÎÉ•Ïù¥ÏôÄ ÎòîÍπ®Ïùò<br>ÎπÑÎ∞Ä ÍµêÌôòÏùºÍ∏∞</h2>
            <div class="diary-belt" id="diary-belt">
                <div class="silver-lock-frame">
                    <div class="dial-window" onclick="rotateDial(0)"><div class="dial-strip" id="strip-0"><div class="dial-number">0</div><div class="dial-number">1</div><div class="dial-number">2</div><div class="dial-number">3</div><div class="dial-number">4</div><div class="dial-number">5</div></div></div>
                    <div class="dial-window" onclick="rotateDial(1)"><div class="dial-strip" id="strip-1"><div class="dial-number">0</div><div class="dial-number">1</div><div class="dial-number">2</div><div class="dial-number">3</div><div class="dial-number">4</div><div class="dial-number">5</div></div></div>
                    <div class="dial-window" onclick="rotateDial(2)"><div class="dial-strip" id="strip-2"><div class="dial-number">0</div><div class="dial-number">1</div><div class="dial-number">2</div><div class="dial-number">3</div><div class="dial-number">4</div><div class="dial-number">5</div></div></div>
                </div>
            </div>
        </div>

        <div class="paper-area" id="paper-area">
            <div class="side-tabs" id="main-tabs">
                <div class="tab" style="background:#A9C9A9;" onclick="location.reload()">ÌëúÏßÄ</div>
                <div class="tab" style="background:#E9B2B2;" onclick="showSection('write')">Ïì∞Í∏∞</div>
                <div class="tab" style="background:#A2C4D9;" onclick="fetchDiaryList()">ÏùΩÍ∏∞</div>
            </div>

            <section id="write-section" class="active">
                <div class="meta-line" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <div id="formatted-date" style="font-weight:bold; color:#666; font-size:13px;"></div>
                    <div class="weather-row">
                        <span class="weather-btn selected" onclick="selectWeather(this, '‚òÄÔ∏è')">‚òÄÔ∏è</span>
                        <span class="weather-btn" onclick="selectWeather(this, 'üåßÔ∏è')">üåßÔ∏è</span>
                        <span class="weather-btn" onclick="selectWeather(this, '‚òÅÔ∏è')">‚òÅÔ∏è</span>
                        <span class="weather-btn" onclick="selectWeather(this, '‚ùÑÔ∏è')">‚ùÑÔ∏è</span>
                    </div>
                </div>

                <div class="title-row">
                    <span class="title-label">Ï†úÎ™©:</span>
                    <input type="text" id="diary-title" class="title-input" placeholder="ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.">
                    
                    <div style="display:flex; gap:5px; margin-left:8px; border-left:1px solid #eee; padding-left:8px;">
                        <span class="author-btn selected" onclick="selectAuthor(this, 'üê±')">üê±</span>
                        <span class="author-btn" onclick="selectAuthor(this, 'üê∂')">üê∂</span>
                    </div>
                </div>

                <div style="font-size:11px; color:#e91e63; margin-bottom:5px; cursor:pointer;" onclick="document.getElementById('photo-input').click()">[üì∏ ÏÇ¨ÏßÑ Ï∂îÍ∞Ä]</div>
                <input type="file" id="photo-input" accept="image/*" style="display:none;" onchange="addPhotoSticker(this)">
                
                <textarea id="diary-body" style="flex:1; font-size:15px; border:none; outline:none; font-family:'DungGeunMo'; background:transparent; line-height:1.6;" placeholder="Ïò§Îäò ÌïòÎ£® ÏûàÏóàÎçò ÏùºÏùÑ Í≥µÏú†Ìï¥Ï§ò:)"></textarea>
                
                <div id="write-sticker-layer" class="sticker-layer"></div>
                <button id="send-btn" onclick="saveDiary()" style="background:var(--diary-pink); color:white; border:none; padding:12px; border-radius:20px; font-family:'DungGeunMo'; width:100%; margin-top:5px; z-index:3000; position:relative;">Ï†ÄÏû• ‚ú®</button>
            </section>

            <section id="view-section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <input type="date" id="target-date" onchange="jumpToDate(this.value)" style="font-family:'DungGeunMo'; font-size:11px; border:1px solid #ddd; border-radius:5px;">
                    <div style="display:flex; gap:8px;">
                        <span class="author-btn" id="filter-cat" onclick="filterByAuthor('üê±')">üê±</span>
                        <span class="author-btn" id="filter-dog" onclick="filterByAuthor('üê∂')">üê∂</span>
                        <span style="font-size:15px; cursor:pointer;" onclick="fetchDiaryList()">üîÑ</span>
                    </div>
                </div>
                <div id="v-header" style="display:flex; justify-content:space-between; align-items:center;">
                    <div id="v-date" style="font-size:11px; color:#666;"></div>
                    <div id="v-author" style="font-size:18px;"></div>
                </div>
                <h2 id="v-title" style="margin:5px 0; border-bottom:1px solid #eee; font-size:17px; padding-bottom:5px;"></h2>
                <div id="v-body" style="line-height:1.6; white-space:pre-wrap; flex:1; overflow-y:auto; font-size:14px; z-index:11; position:relative;"></div>
                <div id="v-photo-area" class="sticker-layer"></div>
                <button id="edit-btn" onclick="startEditing()" style="background:#eee; color:#666; border:none; padding:8px; border-radius:10px; font-family:'DungGeunMo'; font-size:12px; margin-top:5px; z-index:3000;">Ïù¥ ÏùºÍ∏∞ ÏàòÏ†ïÌïòÍ∏∞ ‚úèÔ∏è</button>
            </section>
        </div>
    </div>

    <div class="global-controls" id="sticker-btns">
        <button class="control-btn" onclick="openInputModal('Ïù¥Î™®ÏßÄ')">Ïù¥Î™®ÏßÄ</button>
        <button class="control-btn" onclick="openInputModal('Í∏ÄÎÑ£Í∏∞')">Í∏ÄÎÑ£Í∏∞</button>
        <button class="control-btn" style="background:#fff3cd;" onclick="saveCover()">Ï†ÄÏû•</button>
    </div>

    <div id="custom-modal">
        <div class="modal-content">
            <div id="modal-msg" style="font-size: 14px; color: #666;">ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî</div>
            <input type="text" id="modal-input">
            <div class="modal-btns">
                <button onclick="closeModal(false)">Ï∑®ÏÜå</button>
                <button style="background: var(--diary-pink); color: white;" onclick="closeModal(true)">ÌôïÏù∏</button>
            </div>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzH6No_BA3NKNZG4b9Dv5UPc6NzcU-T9O2vxRQn-VccDQEfapDVgueqQv0W5ka-nkPH/exec";
        let dialValues = [0,0,0], selectedWeather = '‚òÄÔ∏è', selectedAuthor = 'üê±', diaryData = [], currentIndex = 0;
        let isEditing = false, editDate = "";
        const pastelColors = ['#FFF0F5', '#E6E6FA', '#F0FFF0', '#FFFACD', '#F0F8FF', '#FDF5E6'];
        let currentPaperColor = '#ffffff';

        document.getElementById('formatted-date').innerText = new Date().toLocaleDateString();
        window.onload = () => { loadCover(); checkNfcUnlock(); };

        function checkNfcUnlock() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('key') === 'open') setTimeout(unlockDiary, 500);
        }

        function rotateDial(idx) {
            dialValues[idx] = (dialValues[idx] + 1) % 6;
            document.getElementById(`strip-${idx}`).style.transform = `translateY(-${dialValues[idx] * 38}px)`;
            if (dialValues.join('') === "531") unlockDiary();
        }

        function unlockDiary() {
            document.getElementById('diary-cover').style.transform = "rotateY(-110deg)";
            document.getElementById('diary-cover').style.opacity = "0";
            document.getElementById('diary-belt').style.display = "none";
            document.getElementById('sticker-btns').style.display = "none";
            const paper = document.getElementById('paper-area');
            paper.style.display = "flex";
            paper.classList.add('theme-grid');
            document.getElementById('main-tabs').style.display = 'flex';
            setRandomPaper();
        }

        function setRandomPaper() {
            currentPaperColor = pastelColors[Math.floor(Math.random() * pastelColors.length)];
            document.getElementById('paper-area').style.backgroundColor = currentPaperColor;
        }

        function showSection(id) {
            document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
            document.getElementById(id + '-section').classList.add('active');
            if(id === 'write' && !isEditing) { resetWriteForm(); setRandomPaper(); }
        }

        function resetWriteForm() {
            isEditing = false;
            document.getElementById('diary-title').value = "";
            document.getElementById('diary-body').value = "";
            document.getElementById('write-sticker-layer').innerHTML = "";
            document.getElementById('send-btn').innerText = "Ï†ÄÏû• ‚ú®";
            document.getElementById('formatted-date').innerText = new Date().toLocaleDateString();
        }

        function selectWeather(el, w) {
            document.querySelectorAll('.weather-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
            selectedWeather = w;
        }

        function selectAuthor(el, a) {
            document.querySelectorAll('#write-section .author-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
            selectedAuthor = a;
        }

        function deselectAll(e) {
            if(!e.target.closest('.sticker-wrapper')) {
                document.querySelectorAll('.sticker-wrapper').forEach(s => s.classList.remove('selected'));
            }
        }

        function createStickerElement(content, type, state, parentId) {
            if(!content || content === "undefined") return;
            const wrapper = document.createElement('div');
            wrapper.className = 'sticker-wrapper';
            wrapper.innerHTML = `<div class="delete-btn">√ó</div><div class="resize-handle"></div>`;
            
            if(type === 'image') {
                const img = document.createElement('img'); img.src = content; wrapper.appendChild(img);
                wrapper.dataset.base64 = content;
            } else {
                const span = document.createElement('span'); span.className = 'sticker-content';
                span.innerText = content; wrapper.appendChild(span);
            }

            const apply = () => {
                wrapper.style.left = state.x + 'px'; wrapper.style.top = state.y + 'px';
                if(type === 'image') { wrapper.style.width = (110 * state.scale) + 'px'; }
                else { const c = wrapper.querySelector('.sticker-content'); if(c) c.style.fontSize = (40 * state.scale) + 'px'; }
                wrapper.style.transform = `translate(-50%, -50%) rotate(${state.rotation || 0}deg)`;
            };

            wrapper.addEventListener('touchstart', e => {
                if(parentId.includes('view')) return;
                e.stopPropagation(); if(e.target.classList.contains('resize-handle')) return;
                document.querySelectorAll('.sticker-wrapper').forEach(s => s.classList.remove('selected'));
                wrapper.classList.add('selected');
                const t = e.touches[0]; const ox = t.clientX - state.x; const oy = t.clientY - state.y;
                const move = me => { me.preventDefault(); state.x = me.touches[0].clientX - ox; state.y = me.touches[0].clientY - oy; apply(); };
                const end = () => { window.removeEventListener('touchmove', move); window.removeEventListener('touchend', end); };
                window.addEventListener('touchmove', move, {passive: false});
                window.addEventListener('touchend', end);
            }, {passive: false});

            wrapper.querySelector('.resize-handle').addEventListener('touchstart', e => {
                e.stopPropagation(); e.preventDefault();
                const t = e.touches[0]; const startDist = Math.hypot(t.clientX - state.x, t.clientY - state.y);
                const startScale = state.scale;
                const move = me => { me.preventDefault(); const dist = Math.hypot(me.touches[0].clientX - state.x, me.touches[0].clientY - state.y); state.scale = startScale * (dist / startDist); apply(); };
                const end = () => { window.removeEventListener('touchmove', move); window.removeEventListener('touchend', end); };
                window.addEventListener('touchmove', move, {passive: false});
                window.addEventListener('touchend', end);
            }, {passive: false});

            wrapper.querySelector('.delete-btn').addEventListener('touchstart', e => { e.stopPropagation(); wrapper.remove(); });
            document.getElementById(parentId).appendChild(wrapper);
            apply();
        }

        function addPhotoSticker(input) {
            if (input.files && input.files[0]) {
                const r = new FileReader();
                r.onload = e => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 400;
                        let w = img.width, h = img.height;
                        if (w > MAX_WIDTH) { h *= MAX_WIDTH / w; w = MAX_WIDTH; }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        createStickerElement(canvas.toDataURL('image/webp', 0.7), 'image', {x:150, y:200, scale:1}, 'write-sticker-layer');
                    };
                    img.src = e.target.result;
                };
                r.readAsDataURL(input.files[0]);
            }
        }

        async function saveDiary() {
            const title = document.getElementById('diary-title').value, body = document.getElementById('diary-body').value;
            if(!title || !body) return alert("ÎÇ¥Ïö©ÏùÑ Ï±ÑÏõåÏ§ò!");
            const btn = document.getElementById('send-btn');
            btn.innerText = "Ï†ÄÏû• Ï§ë..."; btn.disabled = true;

            const photoEl = document.querySelector('#write-sticker-layer .sticker-wrapper');
            const p = new URLSearchParams();
            p.append('type', isEditing ? 'update' : 'save');
            p.append('date', isEditing ? editDate : new Date().toLocaleDateString()); 
            p.append('weather', selectedWeather);
            p.append('author', selectedAuthor);
            p.append('title', title); p.append('body', body);
            p.append('paperColor', currentPaperColor);

            if(photoEl && photoEl.dataset.base64) {
                p.append('photo', photoEl.dataset.base64);
                p.append('photoX', parseFloat(photoEl.style.left)); 
                p.append('photoY', parseFloat(photoEl.style.top));
                p.append('photoScale', parseFloat(photoEl.style.width)/110);
            }

            try {
                await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: p });
                alert(isEditing ? "ÏàòÏ†ï ÏôÑÎ£å! ‚ú®" : "Ï†ÄÏû• ÏôÑÎ£å! ‚ú®");
                isEditing = false;
                fetchDiaryList(); 
            } catch(e) { alert("Ïò§Î•ò Î∞úÏÉù!"); btn.disabled = false; btn.innerText = "Ï†ÄÏû• ‚ú®"; }
        }

        async function fetchDiaryList() {
            showSection('view'); 
            const bodyView = document.getElementById('v-body');
            bodyView.innerText = "Î°úÎî© Ï§ë...";
            try {
                const res = await fetch(GAS_URL); 
                diaryData = await res.json();
                if(diaryData.length > 0) { currentIndex = diaryData.length - 1; updateView(); }
                else { bodyView.innerText = "ÏûëÏÑ±Îêú ÏùºÍ∏∞Í∞Ä ÏóÜÏñ¥Ïöî."; }
            } catch(e) { bodyView.innerText = "ÏùºÍ∏∞Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏñ¥Ïöî."; }
        }

        function filterByAuthor(emoji) {
            const filtered = diaryData.filter(d => d.author === emoji);
            if(filtered.length > 0) { diaryData = filtered; currentIndex = 0; updateView(); }
            else { alert(emoji + "Í∞Ä Ïì¥ ÏùºÍ∏∞Í∞Ä ÏóÜÏñ¥Ïöî!"); }
        }

        function updateView() {
            const item = diaryData[currentIndex];
            document.getElementById('paper-area').style.backgroundColor = item.paperColor || '#ffffff';
            document.getElementById('v-date').innerText = item.date + " " + (item.weather || '');
            document.getElementById('v-author').innerText = item.author || 'üê±';
            document.getElementById('v-title').innerText = item.title;
            document.getElementById('v-body').innerText = item.body;
            const area = document.getElementById('v-photo-area'); area.innerHTML = "";
            if(item.photo && item.photo.length > 10) {
                createStickerElement(item.photo, 'image', { x: item.photoX, y: item.photoY, scale: item.photoScale || 1 }, 'v-photo-area');
            }
        }

        function startEditing() {
            const item = diaryData[currentIndex];
            isEditing = true; editDate = item.date;
            showSection('write');
            document.getElementById('diary-title').value = item.title;
            document.getElementById('diary-body').value = item.body;
            document.getElementById('formatted-date').innerText = item.date + " (ÏàòÏ†ï Ï§ë)";
            document.getElementById('send-btn').innerText = "ÏàòÏ†ï ÏôÑÎ£å ‚ú®";
            currentPaperColor = item.paperColor;
            document.getElementById('paper-area').style.backgroundColor = currentPaperColor;
            selectedWeather = item.weather || '‚òÄÔ∏è';
            selectedAuthor = item.author || 'üê±';
            document.querySelectorAll('.weather-btn').forEach(b => b.classList.toggle('selected', b.innerText === selectedWeather));
            document.querySelectorAll('#write-section .author-btn').forEach(b => b.classList.toggle('selected', b.innerText === selectedAuthor));
            if(item.photo) {
                createStickerElement(item.photo, 'image', { x: item.photoX, y: item.photoY, scale: item.photoScale || 1 }, 'write-sticker-layer');
            }
        }

        function jumpToDate(val) {
            const d = new Date(val).toLocaleDateString();
            const idx = diaryData.findIndex(item => item.date === d);
            if(idx !== -1) { currentIndex = idx; updateView(); } else alert("Ìï¥Îãπ ÎÇ†ÏßúÏùò ÏùºÍ∏∞Í∞Ä ÏóÜÏñ¥Ïöî!");
        }

        let tsX = 0;
        document.getElementById('view-section').addEventListener('touchstart', e => tsX = e.touches[0].clientX);
        document.getElementById('view-section').addEventListener('touchend', e => {
            const diff = tsX - e.changedTouches[0].clientX;
            if(Math.abs(diff) > 50) {
                if(diff > 0 && currentIndex < diaryData.length-1) { currentIndex++; updateView(); }
                else if(diff < 0 && currentIndex > 0) { currentIndex--; updateView(); }
            }
        });

        async function saveCover() {
            const data = [];
            document.querySelectorAll('#diary-cover .sticker-wrapper').forEach(el => {
                const isImg = el.querySelector('img'); const contentEl = el.querySelector('.sticker-content');
                data.push({ content: isImg ? el.dataset.base64 : (contentEl ? contentEl.innerText : ""), type: isImg ? 'image' : 'text', x: parseFloat(el.style.left), y: parseFloat(el.style.top), scale: isImg ? parseFloat(el.style.width)/110 : (contentEl ? parseFloat(contentEl.style.fontSize)/40 : 1) });
            });
            const p = new URLSearchParams(); p.append('type', 'saveCover'); p.append('data', JSON.stringify(data));
            await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: p });
            alert("ÌëúÏßÄ Ï†ÄÏû•! üíæ");
        }

        async function loadCover() {
            try {
                const res = await fetch(GAS_URL + "?type=getCover");
                const data = await res.json();
                data.forEach(d => createStickerElement(d.content, d.type || 'text', d, 'diary-cover'));
            } catch(e) {}
        }

        let activeCallback = null;
        function openInputModal(type) {
            const modal = document.getElementById('custom-modal');
            const input = document.getElementById('modal-input');
            input.value = (type === 'Ïù¥Î™®ÏßÄ') ? "üêæ" : "ÏïàÎÖï!";
            document.getElementById('modal-msg').innerText = type + " ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî";
            modal.style.display = 'flex';
            input.focus();
            activeCallback = (val) => { if(val) createStickerElement(val, 'text', {x:150, y:200, scale:1}, 'diary-cover'); };
        }
        function closeModal(isConfirm) {
            if(isConfirm && activeCallback) activeCallback(document.getElementById('modal-input').value);
            document.getElementById('custom-modal').style.display = 'none';
        }
    </script>
</body>
</html>